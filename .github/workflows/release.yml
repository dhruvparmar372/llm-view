name: Build & Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: extension
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: extension/package-lock.json

      - run: npm ci
      - run: npm test
      - run: npm run build

      - name: Read version from manifest
        id: version
        run: |
          VERSION=$(jq -r '.version' src/manifest.json)
          echo "value=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Package extension
        run: |
          cd dist
          zip -r ../llm-view-${{ steps.version.outputs.value }}.zip .

      - name: Create release
        working-directory: extension
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="v${{ steps.version.outputs.value }}"
          ZIP="llm-view-${{ steps.version.outputs.value }}.zip"

          # Delete existing release/tag for this version if it exists
          gh release delete "$TAG" --yes 2>/dev/null || true
          git push origin :"$TAG" 2>/dev/null || true

          # Create the release with the versioned zip
          gh release create "$TAG" "$ZIP" \
            --title "llm-view ${{ steps.version.outputs.value }}" \
            --generate-notes

          # Copy to llm-view.zip for the "latest" convenience artifact
          cp "$ZIP" llm-view.zip

          # Update the "latest" release
          gh release delete latest --yes 2>/dev/null || true
          git push origin :latest 2>/dev/null || true

          gh release create latest llm-view.zip \
            --title "Latest â€” llm-view ${{ steps.version.outputs.value }}" \
            --notes "Convenience release pointing to the latest build (v${{ steps.version.outputs.value }})." \
            --latest
